name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper versioning
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools
    
    - name: Verify package structure
      run: |
        echo "ğŸ“ Checking project structure..."
        ls -la
        echo "ğŸ“„ Checking pyproject.toml..."
        cat pyproject.toml | head -20
        echo "ğŸ Checking __init__.py..."
        if [ -f "__init__.py" ]; then
          cat __init__.py | head -10
        else
          echo "âŒ __init__.py not found!"
        fi
    
    - name: Build package
      run: |
        echo "ğŸ”¨ Building package..."
        python -m build
        echo "ğŸ“¦ Build artifacts:"
        ls -la dist/
    
    - name: Check package
      run: |
        echo "âœ… Checking package integrity..."
        twine check dist/*
        echo "ğŸ“‹ Package contents:"
        tar -tzf dist/*.tar.gz | head -20
    
    - name: Upload to Test PyPI
      if: github.event_name == 'workflow_dispatch'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "ğŸ§ª Uploading to Test PyPI..."
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âŒ TEST_PYPI_API_TOKEN not set in GitHub Secrets!"
          echo "â„¹ï¸  Skipping Test PyPI upload."
          exit 0
        fi
        twine upload --repository testpypi dist/* --verbose --non-interactive
    
    - name: Upload to PyPI
      if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ Uploading to PyPI..."
        if [ -z "$TWINE_PASSWORD" ]; then
          echo "âŒ PYPI_API_TOKEN not set in GitHub Secrets!"
          echo "Please add your PyPI API token to GitHub Secrets."
          echo "Go to: Settings â†’ Secrets and variables â†’ Actions"
          echo "Add: PYPI_API_TOKEN = pypi-your_token_here"
          exit 1
        fi
        twine upload dist/* --verbose --non-interactive
    
    - name: Output package info
      if: success()
      run: |
        echo "ğŸ‰ Package uploaded successfully!"
        echo "ğŸ“¦ Package name: ssm-metarl-unified"
        echo "ğŸ”— PyPI URL: https://pypi.org/project/ssm-metarl-unified/"
        echo "ğŸ’¿ Install: pip install ssm-metarl-unified"

  test-install:
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')) && success()
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Wait for package to be available
      run: |
        echo "â³ Waiting for package to be available on PyPI..."
        sleep 60
    
    - name: Test installation from PyPI
      run: |
        echo "ğŸ“¥ Testing installation from PyPI..."
        pip install ssm-metarl-unified
        echo "âœ… Package installed successfully!"
    
    - name: Test basic imports
      run: |
        echo "ğŸ” Testing basic imports..."
        python -c "
        import ssm_metarl_unified
        print(f'âœ… Package version: {ssm_metarl_unified.__version__}')
        print('âœ… Basic import successful!')
        "
    
    - name: Test core components
      run: |
        echo "ğŸ§ª Testing core components..."
        python -c "
        try:
            from ssm_metarl_unified import StateSpaceModel, MetaMAML
            print('âœ… Core imports successful!')
            
            # Test model creation
            model = StateSpaceModel(state_dim=32, input_dim=4, output_dim=2)
            print('âœ… Model creation successful!')
            
            print('ğŸ‰ All tests passed!')
        except Exception as e:
            print(f'âŒ Test failed: {e}')
            raise
        "
    
    - name: Test CLI tools
      run: |
        echo "ğŸ”§ Testing CLI tools..."
        ssm-metarl-train --help > /dev/null && echo "âœ… ssm-metarl-train works!" || echo "âš ï¸ ssm-metarl-train not available"
        ssm-metarl-benchmark --help > /dev/null && echo "âœ… ssm-metarl-benchmark works!" || echo "âš ï¸ ssm-metarl-benchmark not available"
        ssm-metarl-test > /dev/null && echo "âœ… ssm-metarl-test works!" || echo "âš ï¸ ssm-metarl-test not available"